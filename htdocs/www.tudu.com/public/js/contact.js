var TOP=TOP||getTop();var Contact=Contact||{};Contact.deleteContact=function(e,a,b){if(!confirm(TOP.TEXT.CONFIRM_DELETE_CONTACT)){return false}if(typeof a=="undefined"){a=false}if(a){var d=new Array();d=e.split(",");for(var c=0;c<d.length;c++){if(d[c].indexOf("@")>-1){TOP.showMessage(TOP.TEXT.NOT_DELETE_SYSTEM_CONTACT);return false}}}$.ajax({type:"GET",dataType:"json",url:"/contact/delete?ctid="+e,success:function(f){TOP.showMessage(f.message,5000,f.success?"success":null);TOP.Contact.clear();if(f.success&&typeof b!="undefined"){location=b}else{location=location}},error:function(f){TOP.showMessage(TOP.TEXT.PROCESSING_ERROR)}})};Contact.addMember=function(b){if(!a){var a=Contact.getKey()}if(!a.length){return TOP.showMessage(TOP.TEXT.NOTHING_SELECTED)}$.ajax({type:"POST",dataType:"json",data:{gid:b,key:a,type:"add"},url:"/contact/group",success:function(c){TOP.showMessage(c.message,5000,c.success?"success":null);if(c.success){TOP.Contact.clear();location="/contact/?type=contact&groupid="+b}},error:function(c){TOP.showMessage(TOP.TEXT.PROCESSING_ERROR)}})};Contact.removeMember=function(a,b){$.ajax({type:"POST",dataType:"json",data:{gid:a,ctid:b,type:"remove"},url:"/contact/group",success:function(c){TOP.showMessage(c.message,5000,c.success?"success":null);TOP.Contact.clear()},error:function(c){TOP.showMessage(TOP.TEXT.PROCESSING_ERROR)}})};Contact.getKey=function(){var a=[];$(':checkbox[name="addr[]"]:checked').each(function(){a.push(this.value)});return a};Contact.chat=function(b){var a=getTop();a.TuduTalk.talk(b,function(){if(!$.browser.msie){TOP.TuduTalk.openTalk("tdim://chat?jid="+b);return}var c=getTop();var e=TOP.Frame.Dialog.show({title:c.TEXT.HINT,body:"<p>"+c.TEXT.TALK_HINT+"</p>",buttons:[{text:c.TEXT.INSTALL_NOW,cls:"btn",events:{click:function(){window.open()}}},{text:c.TEXT.DONOT_INSTALL,cls:"btn",events:{click:function(){e.close()}}}]})})};Contact.search=function(a){if(!a){return false}else{location.href="/contact/search?keyword="+encodeURIComponent(a)}};Contact.deptTree=null;Contact.initSearch=function(a,d,c){Contact.initDeptTree(d.deptid);var b=parseInt($("#contact-list tr").length);if(c.liststyle){$("span.count").text(b);$("#contact-list tr").mousemove(function(){$(this).addClass("over")}).mouseout(function(){$(this).removeClass("over")}).each(function(){var h=$(this),e=h.attr("_groups"),f=h.attr("_email");if(e){e=e.split("|");for(var g=0,j=e.length;g<j;g++){if(!e[g]||e[g].indexOf("^")!=-1){continue}Contact.appendGroup($(this),e[g])}}h.find("td:not(:eq(0))").click(function(){if(f!==undefined){location="/contact/view?email="+h.attr("_email")+"&back="+a}else{location="/contact/view?ctid="+h.attr("_ctid")+"&back="+a}})})}else{$("span.count").text(b-1);$(".list_over tbody tr").mousemove(function(){$(this).removeClass();$(this).css("cursor","text")})}$(document).ready(function(){$("#keyword").bind("keyup",function(f){if(f.keyCode=="13"){var e=$("#keyword").val();Contact.search(e)}})});$("#dosearch").click(function(){var e=$("#keyword").val();Contact.search(e)});$('input[name="checkall"]').click(function(){TOP.checkBoxAll("addr[]",this.checked,document.body);var e=$(':checkbox[name="addr[]"]:checked').size();$('button[name="tudu"]').attr("disabled",e<=0);$('button[name="delete"]').attr("disabled",e<=0)});$(':checkbox[name="addr[]"]').click(function(g){var f=$(':checkbox[name="addr[]"]:checked').size();$('button[name="tudu"]').attr("disabled",f<=0);$('button[name="delete"]').attr("disabled",f<=0);TOP.stopEventBuddle(g)});$('button[name="tudu"]').click(function(){if(!$(':checkbox[name="addr[]"]:checked').size()){return}var e=[];$(':checkbox[name="addr[]"]:checked').each(function(){e.push($(this).attr("_identify"))});location="/tudu/modify/?to="+e.join(encodeURIComponent("\n"))});$('button[name="delete"]').click(function(){var e=Contact.getKey();if(!e.length){return TOP.showMessage(TOP.TEXT.NOTHING_SELECTED)}Contact.deleteContact(e.join(","),true,"/contact/?type=contact")});TOP.keyhint("#keyword","input_tips",true,document.body);$('button[name="create"]').click(function(){location="/contact/modify?back="+a});$('select[name="group"]').change(function(){if(this.value){Contact.addMember(this.value)}});Contact.ajustSize();$(window).bind("scroll",function(){var e=document.body.scrollTop?document.body.scrollTop:document.documentElement.scrollTop;e=e-$(".position").height()-10;if(e>0){$(".float-toolbar").css({position:"relative",top:e+"px"})}else{$(".float-toolbar").css("top","0px")}});window.onresize=Contact.onResize;Contact.onResize()};Contact.initList=function(a,d,c){Contact.initDeptTree(d.deptid);$('select[name="group"]').change(function(){if(this.value){var e=this.value;Contact.addMember(e)}});$(document).ready(function(){$("#keyword").bind("keyup",function(f){if(f.keyCode=="13"){var e=$("#keyword").val();Contact.search(e)}})});$("#dosearch").click(function(){var e=$("#keyword").val();Contact.search(e)});TOP.keyhint("#keyword","input_tips",true,document.body);$('button[name="delete"]').click(function(){var e=Contact.getKey();if(!e.length){return TOP.showMessage(TOP.TEXT.NOTHING_SELECTED)}Contact.deleteContact(e.join(","),false,"/contact/?type=contact")});$('input[name="checkall"]').click(function(){TOP.checkBoxAll("addr[]",this.checked,document.body);var e=$(':checkbox[name="addr[]"]:checked').size();$('button[name="tudu"]').attr("disabled",e<=0);$('button[name="delete"]').attr("disabled",e<=0)});$(':checkbox[name="addr[]"]').click(function(g){var f=$(':checkbox[name="addr[]"]:checked').size();$('button[name="tudu"]').attr("disabled",f<=0);$('button[name="delete"]').attr("disabled",f<=0);TOP.stopEventBuddle(g)});$('button[name="tudu"]').click(function(){if(!$(':checkbox[name="addr[]"]:checked').size()){return}var e=[];$(':checkbox[name="addr[]"]:checked').each(function(){e.push($(this).attr("_identify"))});location="/tudu/modify/?to="+e.join(encodeURIComponent("\n"))});$('button[name="create"]').click(function(){location="/contact/modify?back="+a});if(c.group){$('button[name="delGroup"]').attr("disabled",false);$('button[name="editGroup"]').attr("disabled",false);var b=$('input[name="groupid"]').val();$('button[name="editGroup"]').click(function(){location="/contact/group.modify?gid="+b+"&back="+a});$('button[name="delGroup"]').click(function(){$.ajax({type:"POST",dataType:"json",data:{gid:b},url:"/contact/group.delete",success:function(e){TOP.showMessage(e.message,5000,e.success?"success":null);if(e.success){location="/contact/?type=contact"}},error:function(e){TOP.showMessage(TOP.TEXT.PROCESSING_ERROR)}})})}if(c.liststyle){$("#contact-list tr").each(function(){var g=$(this);g.mousemove(function(){g.addClass("over")}).mouseout(function(){g.removeClass("over")});g.find("td:not(:eq(0))").click(function(){if(d.type=="contact"){location="/contact/view?ctid="+g.attr("_ctid")+"&back="+a}else{location="/contact/view?email="+g.attr("_email")+"&back="+a}});var e=g.attr("_groups");if(!e){return}e=e.split("|");if(e.length){for(var f=0,h=e.length;f<h;f++){if(!e[f]||e[f].indexOf("^")!=-1){continue}Contact.appendGroup($(this),e[f])}}})}else{$(".list_over tbody tr").mousemove(function(){$(this).removeClass();$(this).css("cursor","text")})}Contact.ajustSize();$(window).bind("scroll",function(){var e=document.body.scrollTop?document.body.scrollTop:document.documentElement.scrollTop;e=e-$(".position").height()-10;if(e>0){$(".float-toolbar").css({position:"relative",top:e+"px"})}else{$(".float-toolbar").css("top","0px")}});window.onresize=Contact.onResize;Contact.onResize()};Contact.ajustSize=function(){var a=Math.max(document.body.clientHeight-30,$(".c_left").height());$(".contacts_box").css({minHeight:a-10+"px"});if($.browser.msie&&$.browser.version<"7.0"){$(".contacts_box").css({height:a-10+"px"})}};Contact.onResize=function(){var a=$('table[class="gird_fix"] td:eq(0)').width();if(a<=800){$('table[class="gird_fix"] td:eq(0)').css({width:"800px"});$(".position").css("width","995px");$(".float-toolbar").css("width","800px");$(".c_left").addClass("less_left");$(".c_right").addClass("less_right")}else{$('table[class="gird_fix"] td:eq(0)').css({width:"100%"});$(".position").css("width","100%");$(".float-toolbar").css({width:a+"px"});$(".c_left").removeClass("less_left");$(".c_right").removeClass("less_right")}};Contact.appendGroup=function(g,a){if(_CUS_GROUPS[a]==undefined){return}if($("#"+g.attr("id")+"-group-"+a).size()){return}var f=$("#group-tpl").clone(),d=_CUS_GROUPS[a],b=g.find("div.label_div"),c=g.attr("_ctid"),h=f.find(".tag_close");f.attr({id:"ct-"+g.attr("_ctid")+"-g-"+a}).css({"background-color":d.bgcolor,color:"#fff"});f.find(".tag_txt").text(d.name);h.click(function(e){f.remove();Contact.removeMember(a,c,"/contact/?type=contact");TOP.stopEventBuddle(e)}).html("&nbsp;").hide();f.mouseover(function(e){if(!f.timer){f.timer=setTimeout(function(){f.find(".tag_close").show();clearTimeout(f.timer)},500)}}).mouseout(function(e){e=window.event||e;var j=f.offset();var i=e.clientX>j.left&&e.clientX<j.left+f.width()&&e.clientY>j.top&&e.clientY<j.top+f.height();if(!i){clearTimeout(f.timer);f.timer=null;f.find(".tag_close").hide()}}).click(function(e){location="/contact/?type=contact&groupid="+encodeURIComponent(a);TOP.stopEventBuddle(e)});b.append(f)};Contact.initDeptTree=function(a){if(null==Contact.deptTree){Contact.deptTree=new $.tree({id:"dept-tree",idKey:"id",idPrefix:"dept-",cls:"contact-dept-tree",template:'<a href="javascript:void(0);" title="{name}">{name}</a>'})}Contact.deptTree.appendTo("#dept-tree-ct");TOP.Cast.load(function(b){var h=TOP.Cast.get("depts"),f=null,e=null;for(var d=0,j=h.length;d<j;d++){var e=h[d].deptid.replace("^","_");if(h[d].deptid=="^root"){h[d].deptname=TOP._ORGNAME}var g=new $.treenode({data:{id:e,name:h[d].deptname},events:{mouseover:function(c){$(this).find(".tree-node-el:eq(0)").addClass("tree-node-over");TOP.stopEventBuddle(c)},mouseout:function(c){$(this).find(".tree-node-el:eq(0)").removeClass("tree-node-over");TOP.stopEventBuddle(c)},click:function(i){var c=this.id.replace("dept-","");if(c.indexOf("_")!=-1){c=c.replace("_","^")}location="/contact/?deptid="+c;TOP.stopEventBuddle(i)}}});if(h[d].parentid){if(h[d].parentid.indexOf("^")!=-1){h[d].parentid=h[d].parentid.replace("^","_")}f=Contact.deptTree.find(h[d].parentid,true);if(f){f.appendChild(g)}}else{Contact.deptTree.appendNode(g)}}Contact.deptTree.find("_root",true).expand();if(typeof a!="undefined"&&null!==a){a=a.replace("^","_");var g=Contact.deptTree.find(a,true);if(g){if(g.parent){g.parent.expand()}$("#dept-"+a+" .tree-node-el:eq(0)").addClass("tree-node-selected")}}})};Contact.initView=function(c,a,b){$('button[name="back"]').click(function(){location=b});if($('button[name="delete"]').size()){$('button[name="delete"]').click(function(){Contact.deleteContact(c,false,"/contact/?type=contact")})}if($('button[name="modify"]').size()){$('button[name="modify"]').click(function(){location="/contact/modify?ctid="+c+"&back="+a})}$('button[name="send"]').click(function(){var d=$(this).attr("_to");location="/tudu/modify?to="+d})};if(typeof(getTop)!="function"){function getTop(){return parent}};
